<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø°ÙƒÙŠ V2.5 - Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø±ÙŠØ§Ø¯Ø©</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* =========================================================================
           1. Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† (Professional Theme System)
           =========================================================================
        */
        :root {
            --primary: #0056b3;         
            --primary-dark: #003d80;    
            --primary-light: #e0f2fe;
            --accent: #f59e0b;
            --dark: #0f172a;            
            --surface: #ffffff;        
            --surface-light: #f1f5f9;   
            --border: #e2e8f0;          
            --text: #1e293b;            
            --text-muted: #64748b;        
            --gold: #d97706;            
            --success: #10b981;        
            --error: #ef4444;            
            --warning: #f59e0b;        
            --info: #0ea5e9;            
            --purple: #8b5cf6;
            --glass: rgba(255, 255, 255, 0.95);
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 10px 15px -3px rgba(0,0,0,0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.1);
            --bg-image: url('https://a.top4top.io/p_36115ao3o1.jpg');
            --radius-sm: 12px;
            --radius-md: 20px;
            --radius-lg: 32px;
        }

        /* =========================================================================
           2. Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (Global Styles)
           =========================================================================
        */
        * { 
            box-sizing: border-box; 
            outline: none; 
            -webkit-tap-highlight-color: transparent; 
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body {
            font-family: 'Cairo', sans-serif; 
            background-color: var(--surface-light); 
            color: var(--text); 
            margin: 0; 
            min-height: 100vh;
            background-image: linear-gradient(rgba(241, 245, 249, 0.9), rgba(241, 245, 249, 0.9)), var(--bg-image);
            background-size: cover; 
            background-position: center; 
            background-attachment: fixed;
            overflow-x: hidden;
            line-height: 1.6;
        }

        .app-wrapper { 
            max-width: 650px; 
            margin: 0 auto; 
            min-height: 100vh; 
            position: relative; 
            padding-bottom: 120px; 
        }
        
        .hidden { display: none !important; }

        /* Loader */
        #loader {
            position: fixed; inset: 0; background: var(--dark);
            z-index: 99999; display: flex; 
            flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        .loader-ring {
            width: 80px; height: 80px;
            border: 8px solid var(--primary-light);
            border-top: 8px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* =========================================================================
           3. Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠ (Glassmorphism UI)
           =========================================================================
        */
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-md); 
            padding: 24px; 
            margin: 16px;
            box-shadow: var(--shadow-md); 
            position: relative; 
            overflow: hidden;
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--info));
            opacity: 0.8;
        }

        /* =========================================================================
           4. Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ø¨Ù„Ø§ØºØ§Øª (Header & Banner)
           =========================================================================
        */
        .main-banner {
            height: 240px; 
            background: linear-gradient(135deg, rgba(0, 86, 179, 0.85), rgba(15, 23, 42, 0.95)), var(--bg-image);
            background-size: cover; background-position: center;
            display: flex; flex-direction: column; justify-content: flex-end; padding: 30px;
            border-bottom-left-radius: var(--radius-lg); border-bottom-right-radius: var(--radius-lg); 
            margin-bottom: 25px; box-shadow: var(--shadow-lg); position: relative;
        }

        .header-top {
            position: absolute; top: 25px; left: 25px; right: 25px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .bell-btn {
            background: rgba(255,255,255,0.15); width: 45px; height: 45px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; 
            backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.2); position: relative;
        }
        .bell-badge {
            position: absolute; top: 10px; right: 10px; width: 10px; height: 10px;
            background: var(--error); border-radius: 50%; display: none; border: 2px solid #fff;
            animation: pulse 2s infinite;
        }

        .user-avatar-container { 
            position: relative; width: 90px; height: 90px; border-radius: 50%;
        }
        .user-avatar-container img {
            width: 100%; height: 100%; border-radius: 50%;
            border: 4px solid rgba(255,255,255,0.2); object-fit: cover;
            background: #fff; display: block;
        }
        .frame-overlay { position: absolute; inset: -6px; pointer-events: none; border-radius: 50%; z-index: 2; }
        .f-gold { border: 6px solid #ffd700; box-shadow: 0 0 15px rgba(255,215,0,0.4); }
        .f-blue { border: 6px dashed var(--primary); }
        .f-grad { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); padding: 5px; }

        /* =========================================================================
           5. Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ø¥Ø¯Ø®Ø§Ù„ (Inputs & Buttons)
           =========================================================================
        */
        .input-group { margin-bottom: 20px; }
        .input-group label { 
            display: block; font-size: 13px; color: var(--text-muted); 
            margin-bottom: 8px; font-weight: 700; margin-right: 5px;
        }
        input, select, textarea {
            width: 100%; padding: 14px 18px; background: var(--surface-light); 
            border: 2px solid transparent; border-radius: var(--radius-sm); color: var(--text); 
            font-family: 'Cairo', sans-serif; font-size: 14px; font-weight: 600;
        }
        input:focus, select:focus, textarea:focus { 
            border-color: var(--primary); background: #fff; 
            box-shadow: 0 0 0 4px rgba(0, 86, 179, 0.05); 
        }

        .btn-main {
            width: 100%; padding: 16px; background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none; border-radius: var(--radius-sm); color: white; font-weight: 800; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 12px;
            box-shadow: 0 8px 20px rgba(0, 86, 179, 0.25); font-size: 15px;
        }
        .btn-main:active { transform: scale(0.96); }
        .btn-main:disabled { opacity: 0.7; cursor: not-allowed; }

        .btn-outline {
            background: transparent; border: 2px solid var(--border); color: var(--text);
            padding: 12px; border-radius: var(--radius-sm); font-weight: 700; cursor: pointer;
        }

        /* =========================================================================
           6. Ø´Ø§Ø´Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆÙ„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± (Reporting & Admin UI)
           =========================================================================
        */
        .report-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .stat-card {
            background: white; padding: 20px; border-radius: var(--radius-sm);
            text-align: center; border: 1px solid var(--border);
        }
        .stat-card i { font-size: 24px; color: var(--primary); margin-bottom: 10px; }
        .stat-card h4 { margin: 0; font-size: 12px; color: var(--text-muted); }
        .stat-card p { margin: 5px 0 0; font-size: 22px; font-weight: 900; color: var(--text); }

        .tech-report-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; border-bottom: 1px solid var(--border);
        }
        .tech-report-item:last-child { border-bottom: none; }

        .admin-data-tag {
            display: inline-flex; align-items: center; gap: 8px;
            background: var(--primary-light); color: var(--primary);
            padding: 6px 14px; border-radius: 50px; margin: 4px; font-size: 12px; font-weight: 700;
        }
        .admin-data-tag i { cursor: pointer; color: var(--error); }

        /* =========================================================================
           7. Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ (Bottom Navigation)
           =========================================================================
        */
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; right: 0; max-width: 650px; margin: 0 auto; 
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px);
            border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: flex-end; 
            padding: 12px 25px 30px; z-index: 900; border-top-left-radius: var(--radius-lg); border-top-right-radius: var(--radius-lg);
            box-shadow: 0 -10px 30px rgba(0,0,0,0.08);
        }
        .nav-item { text-align: center; color: #94a3b8; font-size: 11px; cursor: pointer; width: 60px; font-weight: 700; }
        .nav-item i { font-size: 22px; margin-bottom: 6px; display: block; transition: 0.3s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-5px); color: var(--primary); }

        .nav-add-btn {
            width: 65px; height: 65px; background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 28px;
            box-shadow: 0 10px 25px rgba(0, 86, 179, 0.4); transform: translateY(-30px); border: 6px solid var(--surface-light);
        }

        /* =========================================================================
           8. ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ù„Ø§Øº (Request Card)
           =========================================================================
        */
        .request-card {
            border-right: 5px solid var(--border);
            cursor: pointer;
        }
        .request-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
        .status-pill {
            padding: 6px 14px; border-radius: 50px; font-size: 11px; font-weight: 800;
            display: flex; align-items: center; gap: 6px;
        }
        .st-pending { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
        .st-at_engineer { background: #f3e8ff; color: #7e22ce; border: 1px solid #f3e8ff; }
        .st-done { background: #f0fdf4; color: #15803d; border: 1px solid #dcfce7; }
        
        .req-code-badge {
            font-family: 'JetBrains Mono', monospace; background: var(--dark); color: white;
            padding: 2px 8px; border-radius: 6px; font-size: 11px;
        }

        /* =========================================================================
           9. Ù…ÙŠØ¯ÙŠØ§ (Media)
           =========================================================================
        */
        .media-preview-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px;
        }
        .media-preview-item {
            aspect-ratio: 1; border-radius: 12px; overflow: hidden; position: relative;
            background: var(--surface-light); border: 1px solid var(--border);
        }
        .media-preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .remove-media {
            position: absolute; top: 5px; right: 5px; background: var(--error);
            color: white; width: 20px; height: 20px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer;
        }

        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

    </style>
</head>
<body>

<div class="app-wrapper">
    <audio id="notify-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <div id="loader">
        <div class="loader-ring"></div>
        <h2 style="margin-top:25px; color:white; font-size:22px; font-weight:900; letter-spacing:1px;">Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø±ÙŠØ§Ø¯Ø©</h2>
        <p style="color:var(--text-muted); font-size:14px; margin-top:5px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø°ÙƒÙŠØ©...</p>
    </div>

    <div id="auth-screen" class="hidden" style="min-height:100vh; display:flex; flex-direction:column; justify-content:center; padding:20px;">
        <div class="glass-card" style="text-align:center; padding: 45px 30px;">
            <img src="https://a.top4top.io/p_36115ao3o1.jpg" style="width:100px; height:100px; border-radius:24px; margin-bottom:20px; box-shadow: var(--shadow-lg);">
            <h2 style="margin:0; font-weight:900; font-size: 26px; color:var(--primary-dark);">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h2>
            <p style="color:var(--text-muted); font-size:14px; margin-bottom:40px;">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</p>

            <div id="reg-fields" class="hidden">
                <div class="input-group">
                    <label>Ø§Ù„Ù†ÙˆØ¹</label>
                    <div style="display:flex; gap:10px;">
                        <label style="flex:1;"><input type="radio" name="auth-gender" value="male" checked style="width:auto;"> Ø°ÙƒØ±</label>
                        <label style="flex:1;"><input type="radio" name="auth-gender" value="female" style="width:auto;"> Ø£Ù†Ø«Ù‰</label>
                    </div>
                </div>
                <div class="input-group"><input type="text" id="reg-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„"></div>
                <div class="input-group"><input type="tel" id="reg-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (ÙˆØ§ØªØ³Ø§Ø¨)"></div>
                
                <div class="input-group">
                    <label>Ø§Ù„ÙØ¦Ø© Ø§Ù„ÙˆØ¸ÙŠÙÙŠØ©</label>
                    <select id="reg-role">
                        <option value="employee">Ù…ÙˆØ¸Ù (Ù…Ù‚Ø¯Ù… Ø¨Ù„Ø§ØºØ§Øª)</option>
                        <option value="supervisor">Ù…Ø´Ø±Ù ØµÙŠØ§Ù†Ø©</option>
                        <option value="engineer">Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø®ØªØµ</option>
                        <option value="technician">ÙÙ†ÙŠ ØµÙŠØ§Ù†Ø©</option>
                        <option value="manager">Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</option>
                    </select>
                </div>
                <div class="input-group"><input type="text" id="reg-job" placeholder="Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ø§Ù„Ø¯Ù‚ÙŠÙ‚"></div>
                <div class="input-group"><input type="text" id="reg-loc" placeholder="Ø§Ù„Ù…ÙƒØªØ¨ / Ù…Ù‚Ø± Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ"></div>
            </div>

            <div class="input-group"><input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ"></div>
            <div class="input-group"><input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"></div>
            <div id="confirm-pass-field" class="hidden input-group"><input type="password" id="confirm-password" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"></div>
            
            <button onclick="handleAuth()" id="auth-btn" class="btn-main" style="margin-top:10px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            
            <div onclick="toggleAuth()" style="margin-top:30px; font-size:14px; cursor:pointer; color:var(--text-muted);">
                <span id="auth-switch-text">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <b style="color:var(--primary)">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</b></span>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div class="main-banner">
            <div class="header-top">
                <div class="user-avatar-container" onclick="nav('profile', document.querySelector('.nav-item:nth-child(4)'))">
                    <img id="banner-img" src="">
                    <div id="banner-frame" class="frame-overlay"></div>
                </div>
                <div class="bell-btn" onclick="toggleNotifications()">
                    <i class="fa-regular fa-bell"></i>
                    <div class="bell-badge"></div>
                </div>
            </div>
            <div class="header-content" style="color:white; text-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                <span id="banner-role" style="background:rgba(255,255,255,0.2); padding:4px 12px; border-radius:50px; font-size:11px; font-weight:800; border:1px solid rgba(255,255,255,0.3);">User</span>
                <h1 id="banner-name" style="margin:8px 0 2px; font-size:24px; font-weight:900;">Guest User</h1>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span id="banner-id" style="font-family:'JetBrains Mono'; font-size:12px; opacity:0.8;">ID: ------</span>
                    <i class="fa-regular fa-copy" onclick="copyId()" style="cursor:pointer; font-size:12px;"></i>
                </div>
            </div>
        </div>

        <main id="main-content">
            
            <div id="page-home" class="page-section">
                <div style="display:flex; margin:0 16px 15px; background:white; padding:6px; border-radius:18px; border:1px solid var(--border);">
                    <button class="tab-btn active" onclick="switchTab('active', this)" style="flex:1; padding:10px; border:none; border-radius:12px; font-family:'Cairo'; font-weight:800; font-size:13px; cursor:pointer;">Ø§Ù„Ù†Ø´Ø·Ø©</button>
                    <button class="tab-btn" onclick="switchTab('history', this)" style="flex:1; padding:10px; border:none; border-radius:12px; font-family:'Cairo'; font-weight:800; font-size:13px; cursor:pointer; background:transparent; color:var(--text-muted);">Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
                    <button id="mgr-trash-tab" class="tab-btn hidden" onclick="switchTab('trash', this)" style="flex:1; padding:10px; border:none; border-radius:12px; font-family:'Cairo'; font-weight:800; font-size:13px; cursor:pointer; background:transparent; color:var(--error);">Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª</button>
                </div>
                <div id="requests-feed" style="padding-bottom:20px;"></div>
            </div>

            <div id="page-create" class="page-section hidden">
                <div class="glass-card" style="margin-top:0;">
                    <h3 style="margin:0 0 20px; font-weight:900; color:var(--primary-dark); border-right:5px solid var(--primary); padding-right:15px;">ØªÙ‚Ø¯ÙŠÙ… Ø¨Ù„Ø§Øº ØµÙŠØ§Ù†Ø©</h3>
                    
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                        <div class="input-group"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ø·Ù„</label><input type="date" id="req-date"></div>
                        <div class="input-group"><label>ÙˆÙ‚Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</label><input type="time" id="req-time"></div>
                    </div>

                    <div class="input-group">
                        <label>Ù†ÙˆØ¹ Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</label>
                        <select id="req-type">
                            </select>
                    </div>

                    <div class="input-group">
                        <label>Ø¯Ø±Ø¬Ø© Ø§Ù„Ø§Ø³ØªØ¹Ø¬Ø§Ù„</label>
                        <div style="display:flex; gap:10px;">
                            <label style="flex:1; text-align:center; padding:12px; border:1px solid var(--border); border-radius:12px; cursor:pointer;" class="prio-box">
                                <input type="radio" name="prio" value="low" checked style="display:none;">
                                <i class="fa-regular fa-circle-check" style="display:block; margin-bottom:5px; color:var(--success);"></i>
                                <span style="font-size:12px; font-weight:bold;">Ø¹Ø§Ø¯ÙŠ</span>
                            </label>
                            <label style="flex:1; text-align:center; padding:12px; border:1px solid var(--border); border-radius:12px; cursor:pointer;" class="prio-box">
                                <input type="radio" name="prio" value="medium" style="display:none;">
                                <i class="fa-solid fa-circle-exclamation" style="display:block; margin-bottom:5px; color:var(--warning);"></i>
                                <span style="font-size:12px; font-weight:bold;">Ù…ØªÙˆØ³Ø·</span>
                            </label>
                            <label style="flex:1; text-align:center; padding:12px; border:1px solid var(--border); border-radius:12px; cursor:pointer;" class="prio-box">
                                <input type="radio" name="prio" value="high" style="display:none;">
                                <i class="fa-solid fa-fire-flame-curved" style="display:block; margin-bottom:5px; color:var(--error);"></i>
                                <span style="font-size:12px; font-weight:bold;">Ø¹Ø§Ø¬Ù„ Ø¬Ø¯Ø§Ù‹</span>
                            </label>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø·Ù„ (Ø§Ù„Ù…Ø¨Ù†Ù‰ / Ø§Ù„Ù…ÙƒØ§Ù†)</label>
                        <select id="req-faculty" style="margin-bottom:12px;">
                            </select>
                        <input type="text" id="req-room" placeholder="Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ© Ø£Ùˆ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© (Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø«Ø§Ù„Ø« - ØºØ±ÙØ© 305)">
                    </div>

                    <div class="input-group">
                        <label>ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</label>
                        <textarea id="req-desc" rows="4" placeholder="ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø·Ù„ Ø¨ÙˆØ¶ÙˆØ­ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø³Ø±ÙŠØ¹..."></textarea>
                    </div>

                    <div style="display:flex; gap:12px; margin-bottom:25px;">
                        <button class="btn-outline" style="flex:1; display:flex; flex-direction:column; align-items:center; height:auto; padding:15px;" onclick="document.getElementById('req-files').click()">
                            <i class="fa-solid fa-camera fa-lg" style="margin-bottom:8px; color:var(--primary);"></i>
                            <span style="font-size:12px;">Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±/ÙÙŠØ¯ÙŠÙˆ</span>
                            <input type="file" id="req-files" hidden multiple accept="image/*,video/*" onchange="handleFiles(this)">
                        </button>
                        <button id="mic-trigger" class="btn-outline" style="flex:1; display:flex; flex-direction:column; align-items:center; height:auto; padding:15px;" onclick="toggleRecording()">
                            <i class="fa-solid fa-microphone fa-lg" style="margin-bottom:8px; color:var(--error);"></i>
                            <span style="font-size:12px;">ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ</span>
                        </button>
                    </div>

                    <div id="preview-grid" class="media-preview-grid" style="margin-bottom:20px;"></div>

                    <button onclick="openSupModal()" class="btn-main">Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±Ù <i class="fa-solid fa-chevron-left"></i></button>
                </div>
            </div>

            <div id="page-admin" class="page-section hidden">
                <div class="glass-card" style="border-top: 4px solid var(--purple);">
                    <h3 style="margin-bottom:20px;"><i class="fa-solid fa-chart-line"></i> Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø°ÙƒÙŠ</h3>
                    <div class="report-stat-grid">
                        <div class="stat-card">
                            <i class="fa-solid fa-list-check"></i>
                            <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</h4>
                            <p id="stat-total">0</p>
                        </div>
                        <div class="stat-card">
                            <i class="fa-solid fa-check-double" style="color:var(--success);"></i>
                            <h4>Ø¨Ù„Ø§ØºØ§Øª Ù…ÙƒØªÙ…Ù„Ø©</h4>
                            <p id="stat-done">0</p>
                        </div>
                        <div class="stat-card">
                            <i class="fa-solid fa-hourglass-half" style="color:var(--warning);"></i>
                            <h4>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</h4>
                            <p id="stat-working">0</p>
                        </div>
                        <div class="stat-card">
                            <i class="fa-solid fa-user-slash" style="color:var(--error);"></i>
                            <h4>Ø¨Ù„Ø§ØºØ§Øª Ù…Ø±ÙÙˆØ¶Ø©</h4>
                            <p id="stat-rejected">0</p>
                        </div>
                    </div>
                    <button onclick="generateFullReport()" class="btn-main" style="background:var(--dark);"><i class="fa-solid fa-file-pdf"></i> Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ø§Ù…Ù„ (PDF)</button>
                </div>

                <div class="glass-card" style="border-top: 4px solid var(--accent);">
                    <h3><i class="fa-solid fa-gears"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
                    
                    <div style="margin-top:20px;">
                        <label style="font-weight:800; font-size:14px; display:block; margin-bottom:10px;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ®ØµØµØ§Øª (Types):</label>
                        <div style="display:flex; gap:10px; margin-bottom:15px;">
                            <input type="text" id="new-specialty" placeholder="Ø£Ø¶Ù ØªØ®ØµØµ Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ø§Ù„: ØªØ¨Ø±ÙŠØ¯ ÙˆØªÙƒÙŠÙŠÙ)" style="margin:0;">
                            <button onclick="addSystemData('specialties', 'new-specialty')" class="btn-main" style="width:auto; margin:0;"><i class="fa-solid fa-plus"></i></button>
                        </div>
                        <div id="specialties-list" style="background:var(--surface-light); padding:10px; border-radius:12px; min-height:50px;"></div>
                    </div>

                    <div style="margin-top:25px;">
                        <label style="font-weight:800; font-size:14px; display:block; margin-bottom:10px;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù…Ø§ÙƒÙ† ÙˆØ§Ù„Ù…Ø¨Ø§Ù†ÙŠ (Locations):</label>
                        <div style="display:flex; gap:10px; margin-bottom:15px;">
                            <input type="text" id="new-location" placeholder="Ø£Ø¶Ù Ù…ÙƒØ§Ù† Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ø§Ù„: Ù…Ø¨Ù†Ù‰ Ø§Ù„Ù…Ø¯Ø±Ø¬Ø§Øª)" style="margin:0;">
                            <button onclick="addSystemData('locations', 'new-location')" class="btn-main" style="width:auto; margin:0;"><i class="fa-solid fa-plus"></i></button>
                        </div>
                        <div id="locations-list" style="background:var(--surface-light); padding:10px; border-radius:12px; min-height:50px;"></div>
                    </div>
                </div>
                
                <div class="glass-card" style="border-top: 4px solid var(--success);">
                    <h3><i class="fa-solid fa-user-gear"></i> ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ÙÙ†ÙŠÙŠÙ†</h3>
                    <div id="technicians-performance-list" style="margin-top:15px;">
                        <p style="text-align:center; color:var(--text-muted); font-size:12px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
                    </div>
                </div>
            </div>

            </main>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="nav('home', this)"><i class="fa-solid fa-house-chimney"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
            <div id="nav-admin-btn" class="nav-item hidden" onclick="nav('admin', this)"><i class="fa-solid fa-chart-pie"></i>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
            <div class="nav-add-btn" onclick="nav('create', null)"><i class="fa-solid fa-plus"></i></div>
            <div class="nav-item" onclick="nav('team', this)"><i class="fa-solid fa-user-group"></i>Ø§Ù„ÙØ±ÙŠÙ‚</div>
            <div class="nav-item" onclick="nav('profile', this)"><i class="fa-solid fa-circle-user"></i>Ø­Ø³Ø§Ø¨ÙŠ</div>
        </div>
    </div>
</div>

<div id="report-template" class="hidden" style="padding:40px; font-family:'Cairo'; direction:rtl;">
    <div style="text-align:center; border-bottom:3px solid #000; padding-bottom:20px; margin-bottom:30px;">
        <h1 style="margin:0;">Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø±ÙŠØ§Ø¯Ø© Ù„Ù„Ø¹Ù„ÙˆÙ… ÙˆØ§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§</h1>
        <h2 style="margin:5px 0; color:#444;">ØªÙ‚Ø±ÙŠØ± Ø£Ø¯Ø§Ø¡ Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø¯ÙˆØ±ÙŠ</h2>
        <p id="report-date-print"></p>
    </div>
    <div id="report-content-print"></div>
    <div style="margin-top:50px; display:flex; justify-content:space-between;">
        <div style="text-align:center;"><p>Ø®ØªÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</p><br>__________</div>
        <div style="text-align:center;"><p>ØªÙˆÙ‚ÙŠØ¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</p><br>__________</div>
    </div>
</div>
<div id="page-team" class="page-section hidden">
            <div class="glass-card" style="border-top: 3px solid var(--gold);">
                <h3 style="margin-bottom:20px;"><i class="fa-solid fa-users-viewfinder"></i> Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙˆØ§Ø¯Ø±</h3>
                <div style="display:flex; gap:10px; margin-bottom:25px;">
                    <div style="position:relative; flex:1;">
                        <i class="fa-solid fa-search" style="position:absolute; right:15px; top:18px; color:var(--text-muted);"></i>
                        <input type="text" id="search-query" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ù€ ID Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯..." style="padding-right:45px;">
                    </div>
                    <button onclick="searchUser()" class="btn-main" style="width:auto; padding:0 20px;"><i class="fa-solid fa-magnifying-glass"></i></button>
                </div>
                
                <div id="search-results" class="hidden" style="margin-bottom:30px; animation: fadeIn 0.4s;"></div>

                <div id="friend-reqs" class="hidden" style="background:var(--primary-light); padding:20px; border-radius:20px; margin-bottom:25px; border:1px dashed var(--primary);">
                    <h5 style="margin:0 0 15px; color:var(--primary-dark); font-weight:800;"><i class="fa-solid fa-user-plus"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø¨Ø· Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</h5>
                    <div id="reqs-list"></div>
                </div>

                <h5 style="color:var(--text-muted); font-weight:800; border-bottom:1px solid var(--border); padding-bottom:10px; margin-bottom:15px;">Ø²Ù…Ù„Ø§Ø¦ÙŠ ÙÙŠ Ø§Ù„ÙØ±ÙŠÙ‚:</h5>
                <div id="team-list" style="display:grid; grid-template-columns: 1fr; gap:12px;"></div>
            </div>
        </div>

        <div id="page-profile" class="page-section hidden">
            <div class="glass-card" style="margin-top:10px;">
                <div style="text-align:center;">
                    <div class="user-avatar-container" style="margin: 0 auto 25px; width:120px; height:120px;">
                        <img id="edit-current-pic" src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" style="border:6px solid white;">
                        <div id="edit-frame-overlay" class="frame-overlay"></div>
                        <div onclick="document.getElementById('edit-profile-file').click()" style="position:absolute; bottom:5px; left:5px; background:var(--primary); width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; border:3px solid #fff; box-shadow:var(--shadow-md); z-index:10;">
                            <i class="fa-solid fa-camera-retro" style="color:white; font-size:16px;"></i>
                        </div>
                    </div>
                    <input type="file" id="edit-profile-file" hidden accept="image/*" onchange="previewProfilePic(this)">
                    
                    <div style="margin-bottom:30px;">
                         <p style="font-size:13px; font-weight:800; margin-bottom:15px; color:var(--text-muted);">ØªØ®ØµÙŠØµ Ø¥Ø·Ø§Ø± Ø§Ù„ØªÙ…ÙŠØ² Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</p>
                         <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:12px;">
                             <div class="frame-option selected" style="border:1px solid #ccc; height:50px; border-radius:10px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:10px;" onclick="selectFrame(this, '')">Ø¨Ø¯ÙˆÙ†</div>
                             <div class="frame-option f-gold" style="height:50px; border-radius:10px; cursor:pointer;" onclick="selectFrame(this, 'f-gold')"></div>
                             <div class="frame-option f-blue" style="height:50px; border-radius:10px; cursor:pointer;" onclick="selectFrame(this, 'f-blue')"></div>
                             <div class="frame-option f-grad" style="height:50px; border-radius:10px; cursor:pointer;" onclick="selectFrame(this, 'f-grad')"></div>
                         </div>
                    </div>

                    <div style="background:var(--dark); color:white; padding:12px 25px; border-radius:50px; display:inline-flex; align-items:center; gap:12px; margin-bottom:30px; cursor:pointer;" onclick="copyId()">
                        <span style="font-family:'JetBrains Mono'; font-weight:700;">ID: <span id="edit-id-display">------</span></span>
                        <i class="fa-regular fa-copy"></i>
                    </div>

                    <div style="text-align:right;">
                        <div class="input-group"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ</label><input type="text" id="edit-name"></div>
                        <div class="input-group"><label>Ø§Ù„Ø¬Ù†Ø³</label><select id="edit-gender"><option value="male">Ø°ÙƒØ±</option><option value="female">Ø£Ù†Ø«Ù‰</option></select></div>
                        <div class="input-group"><label>Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label><input type="text" id="edit-job"></div>
                        <div class="input-group"><label>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</label><input type="text" id="edit-loc"></div>
                    </div>
                    
                    <button onclick="saveProfile()" class="btn-main" id="save-profile-btn" style="margin-top:20px;">Ø­ÙØ¸ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª <i class="fa-solid fa-cloud-arrow-up"></i></button>
                    <button onclick="document.getElementById('logout-modal').classList.remove('hidden')" class="btn-outline" style="margin-top:15px; width:100%; border-color:var(--error); color:var(--error);"><i class="fa-solid fa-power-off"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…</button>
                </div>
            </div>
        </div>
    </div>

    <div id="sup-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:450px;">
            <div class="close-btn" onclick="closeModal('sup-modal')"><i class="fa-solid fa-x"></i></div>
            <h3 style="margin-bottom:20px; font-weight:900; color:var(--primary); border-bottom:2px solid var(--primary-light); padding-bottom:10px;">ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø¨Ù„Ø§Øº Ù„Ù„Ù…Ø´Ø±Ù</h3>
            <p style="font-size:12px; color:var(--text-muted); margin-bottom:15px;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ù…Ù†Ø·Ù‚ØªÙƒ Ù„Ø¶Ù…Ø§Ù† Ø³Ø±Ø¹Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©:</p>
            <div id="sup-list" style="max-height:350px; overflow-y:auto; padding:5px;"></div>
            <button onclick="sendRequestFinal()" class="btn-main" id="confirm-send-btn" style="margin-top:20px;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù† <i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="action-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal('action-modal')"><i class="fa-solid fa-xmark"></i></div>
            <h3 id="act-title" style="margin-bottom:20px; font-weight:900; color:var(--dark);">ØªÙ†ÙÙŠØ° Ø¥Ø¬Ø±Ø§Ø¡</h3>
            <textarea id="act-comment" rows="4" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙ†ÙŠØ© Ø£Ùˆ Ø¥Ø¯Ø§Ø±ÙŠØ© Ù‡Ù†Ø§..."></textarea>
            
            <div id="eng-select-area" class="hidden" style="margin-top:20px;">
                <p style="font-size:13px; font-weight:800; color:var(--text-muted); margin-bottom:10px;">ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø§Ù„Ù…Ø®ØªØµ:</p>
                <div id="eng-list-action" class="tech-select-grid"></div>
            </div>

            <div id="tech-select-area" class="hidden" style="margin-top:20px;">
                <p style="font-size:13px; font-weight:800; color:var(--text-muted); margin-bottom:10px;">Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ù…Ù‡Ù…Ø© Ù„ÙÙ†ÙŠ:</p>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <label style="flex:1; cursor:pointer;"><input type="radio" name="tech-type" value="internal" checked onchange="toggleTechType(this.value)"> ÙÙ†ÙŠ Ø¬Ø§Ù…Ø¹ÙŠ</label>
                    <label style="flex:1; cursor:pointer;"><input type="radio" name="tech-type" value="external" onchange="toggleTechType(this.value)"> ÙÙ†ÙŠ Ø®Ø§Ø±Ø¬ÙŠ</label>
                </div>
                <div id="tech-list-action" class="tech-select-grid" style="max-height:200px; overflow-y:auto;"></div>
                <div id="ext-tech-form" class="hidden" style="background:var(--surface-light); padding:15px; border-radius:15px; border:1px dashed var(--border);">
                    <input type="text" id="ext-name" placeholder="Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ Ø£Ùˆ Ø§Ù„Ø´Ø±ÙƒØ©" style="margin-bottom:10px;">
                    <input type="tel" id="ext-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„">
                </div>
            </div>

            <button onclick="submitAction()" id="act-submit-btn" class="btn-main" style="margin-top:25px;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ <i class="fa-solid fa-check-double"></i></button>
        </div>
    </div>

    <div id="request-details-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:550px; background:#fff;">
            <div class="close-btn" onclick="closeModal('request-details-modal')"><i class="fa-solid fa-times"></i></div>
            <div id="req-details-content"></div>
            <div id="action-buttons-detail" style="margin-top:25px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;"></div>
        </div>
    </div>

    <div id="logout-modal" class="modal-overlay hidden">
        <div class="modal-content" style="text-align:center; max-width:320px;">
            <i class="fa-solid fa-triangle-exclamation fa-3x" style="color:var(--error); margin-bottom:15px;"></i>
            <h3 style="margin-bottom:10px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ</h3>
            <p style="font-size:13px; color:var(--text-muted); margin-bottom:25px;">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ</p>
            <div style="display:flex; gap:10px;">
                <button onclick="logout()" class="btn-main" style="background:var(--error);">Ù†Ø¹Ù…ØŒ Ø®Ø±ÙˆØ¬</button>
                <button onclick="closeModal('logout-modal')" class="btn-outline" style="flex:1;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="toast" style="position:fixed; bottom:110px; left:50%; transform:translateX(-50%); background:var(--dark); color:white; padding:12px 25px; border-radius:50px; z-index:10000; display:none; font-size:13px; font-weight:700; box-shadow:var(--shadow-lg); text-align:center; min-width:200px; animation: slideUp 0.3s ease-out;"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    // 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    const firebaseConfig = {
        apiKey: "AIzaSyABwJfEkkbNB8GurZkyj67R8ksVNEXZ11I",
        authDomain: "ryadanur1-375a8.firebaseapp.com",
        projectId: "ryadanur1-375a8",
        storageBucket: "ryadanur1-375a8.firebasestorage.app",
        messagingSenderId: "858244114090",
        appId: "1:858244114090:web:42cee8e98e3984164392d3"
    };

    const CLOUD_NAME = "djzfruh22"; 
    const CLOUD_PRESET = "udyvggup";

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© (Global State)
    let currentUser = null;
    let userData = null;
    let isLoginMode = true;
    let requestsCache = [];
    let uploadQueue = [];
    let isRecording = false;
    let mediaRecorder = null;
    let audioChunks = [];
    let selectedSup = null;
    let currentTab = 'active';
    let isFirstLoad = true;
    let isRegistering = false;
    let systemSpecialties = [];
    let systemLocations = [];

    /* =========================================================================
       2. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ (Auth Logic) - ØªÙ… Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø®Ø·Ø£ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù‡Ù†Ø§
       =========================================================================
    */

    auth.onAuthStateChanged(async (user) => {
        if (isRegistering) return; // Ù…Ù†Ø¹ Ø§Ù„ØªØ¯Ø§Ø®Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯

        if (user) {
            if (!user.emailVerified) {
                toast("âš ï¸ ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ");
                auth.signOut();
                return;
            }
            currentUser = user;
            await initializeAppData();
        } else {
            document.getElementById('loader').classList.add('hidden');
            showScreen('auth-screen');
        }
    });

    async function initializeAppData() {
        try {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ "ØªÙƒØ±Ø§Ø±" Ø¨Ø³ÙŠØ· Ù„ØªØ¬Ù†Ø¨ Race Condition Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
            let doc = await db.collection('users').doc(currentUser.uid).get();
            
            if (!doc.exists) {
                // Ø§Ù†ØªØ¸Ø§Ø± Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø­Ø¯Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ (Ø®Ø§ØµØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯)
                await new Promise(r => setTimeout(r, 1500));
                doc = await db.collection('users').doc(currentUser.uid).get();
            }

            if (doc.exists) {
                userData = doc.data();
                renderHeader();
                setupPermissions();
                loadSystemSettings(); // Ø¬Ù„Ø¨ Ø§Ù„ØªØ®ØµØµØ§Øª ÙˆØ§Ù„Ø£Ù…Ø§ÙƒÙ†
                loadFeed();
                loadTeam();
                loadFriendReqs();
                showScreen('app-container');
            } else {
                throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
            }
        } catch (error) {
            console.error(error);
            toast("âš ï¸ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...");
            setTimeout(() => location.reload(), 3000);
        } finally {
            document.getElementById('loader').classList.add('hidden');
        }
    }

    async function handleAuth() {
        const email = document.getElementById('email').value.trim();
        const pass = document.getElementById('password').value;
        const btn = document.getElementById('auth-btn');

        if (!email || !pass) return toast("âŒ Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';

        try {
            if (isLoginMode) {
                await auth.signInWithEmailAndPassword(email, pass);
            } else {
                isRegistering = true;
                const role = document.getElementById('reg-role').value;
                const name = document.getElementById('reg-name').value.trim();
                const phone = document.getElementById('reg-phone').value.trim();
                const gender = document.querySelector('input[name="auth-gender"]:checked').value;
                const job = document.getElementById('reg-job').value;
                const loc = document.getElementById('reg-loc').value;

                if (!name || !phone) throw new Error("Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©");

                const cred = await auth.createUserWithEmailAndPassword(email, pass);
                
                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙˆØ±Ø§Ù‹ ÙÙŠ Firestore
                await db.collection('users').doc(cred.user.uid).set({
                    uid: cred.user.uid,
                    fullName: name,
                    email: email,
                    role: role,
                    gender: gender,
                    phone: phone,
                    jobTitle: job,
                    location: loc,
                    shortId: Math.random().toString(36).substr(2, 6).toUpperCase(),
                    photoUrl: gender === 'male' ? 'https://cdn-icons-png.flaticon.com/512/4140/4140048.png' : 'https://cdn-icons-png.flaticon.com/512/4140/4140047.png',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                await cred.user.sendEmailVerification();
                toast("âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„! ÙØ¹Ù„ Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ");
                isRegistering = false;
                toggleAuth(); // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø®ÙˆÙ„
            }
        } catch (e) {
            toast("âŒ " + e.message);
            isRegistering = false;
        } finally {
            btn.disabled = false;
            btn.innerText = isLoginMode ? "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„" : "Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨";
        }
    }

    /* =========================================================================
       3. Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… (Manager Features)
       =========================================================================
    */

    async function loadSystemSettings() {
        // Ø¬Ù„Ø¨ Ø§Ù„ØªØ®ØµØµØ§Øª
        db.collection('settings').doc('specialties').onSnapshot(doc => {
            if (doc.exists) {
                systemSpecialties = doc.data().list || [];
                renderSystemDataList('specialties-list', systemSpecialties, 'specialties');
                updateDropdown('req-type', systemSpecialties, "Ø§Ø®ØªØ± Ø§Ù„ØªØ®ØµØµ...");
            }
        });

        // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ù…Ø§ÙƒÙ†
        db.collection('settings').doc('locations').onSnapshot(doc => {
            if (doc.exists) {
                systemLocations = doc.data().list || [];
                renderSystemDataList('locations-list', systemLocations, 'locations');
                updateDropdown('req-faculty', systemLocations, "Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¨Ù†Ù‰...");
            }
        });
    }

    async function addSystemData(type, inputId) {
        const val = document.getElementById(inputId).value.trim();
        if (!val) return;
        
        const currentList = type === 'specialties' ? systemSpecialties : systemLocations;
        if (currentList.includes(val)) return toast("Ø§Ù„Ù…Ø¹Ø·Ù‰ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„");

        await db.collection('settings').doc(type).set({
            list: [...currentList, val]
        }, { merge: true });

        document.getElementById(inputId).value = "";
        toast("âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­");
    }

    async function deleteSystemData(type, val) {
        const currentList = type === 'specialties' ? systemSpecialties : systemLocations;
        const newList = currentList.filter(i => i !== val);
        await db.collection('settings').doc(type).set({ list: newList });
        toast("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù");
    }

    function renderSystemDataList(containerId, list, type) {
        const div = document.getElementById(containerId);
        div.innerHTML = list.map(item => `
            <span class="admin-data-tag">
                ${item} <i class="fa-solid fa-circle-xmark" onclick="deleteSystemData('${type}', '${item}')"></i>
            </span>
        `).join('');
    }

    function updateDropdown(id, list, placeholder) {
        const select = document.getElementById(id);
        if (!select) return;
        let html = `<option value="">${placeholder}</option>`;
        list.forEach(item => {
            html += `<option value="${item}">${item}</option>`;
        });
        select.innerHTML = html;
    }

    /* =========================================================================
       4. Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù… (Reporting Dashboard)
       =========================================================================
    */

    async function generateFullReport() {
        const reportBtn = event.currentTarget;
        reportBtn.disabled = true;
        reportBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';

        const stats = calcStats();
        const techPerf = await getTechPerformance();

        const printArea = document.getElementById('report-content-print');
        document.getElementById('report-date-print').innerText = "ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: " + new Date().toLocaleString('ar-EG');

        let html = `
            <div style="margin-bottom:30px;">
                <h3 style="background:#eee; padding:10px;">Ø£ÙˆÙ„Ø§Ù‹: Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø©</h3>
                <table style="width:100%; border-collapse:collapse; text-align:right;">
                    <tr><td style="border:1px solid #ddd; padding:10px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</td><td style="border:1px solid #ddd; padding:10px; font-weight:bold;">${stats.total}</td></tr>
                    <tr><td style="border:1px solid #ddd; padding:10px;">Ø¨Ù„Ø§ØºØ§Øª ØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡Ø§</td><td style="border:1px solid #ddd; padding:10px; color:green;">${stats.done}</td></tr>
                    <tr><td style="border:1px solid #ddd; padding:10px;">Ø¨Ù„Ø§ØºØ§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</td><td style="border:1px solid #ddd; padding:10px; color:orange;">${stats.working}</td></tr>
                    <tr><td style="border:1px solid #ddd; padding:10px;">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ÙƒÙ„ÙŠØ©</td><td style="border:1px solid #ddd; padding:10px; font-weight:bold;">${((stats.done/stats.total)*100 || 0).toFixed(1)}%</td></tr>
                </table>
            </div>

            <div style="margin-bottom:30px;">
                <h3 style="background:#eee; padding:10px;">Ø«Ø§Ù†ÙŠØ§Ù‹: Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙÙ†ÙŠ</h3>
                <table style="width:100%; border-collapse:collapse; text-align:right;">
                    <thead>
                        <tr style="background:#f9f9f9;">
                            <th style="border:1px solid #ddd; padding:10px;">Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ</th>
                            <th style="border:1px solid #ddd; padding:10px;">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</th>
                            <th style="border:1px solid #ddd; padding:10px;">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${techPerf.map(t => `
                            <tr>
                                <td style="border:1px solid #ddd; padding:10px;">${t.name}</td>
                                <td style="border:1px solid #ddd; padding:10px;">${t.doneTasks}</td>
                                <td style="border:1px solid #ddd; padding:10px;">${t.activeTasks}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;

        printArea.innerHTML = html;

        const opt = {
            margin: 10,
            filename: `Maintenance_Report_${new Date().toLocaleDateString()}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().from(document.getElementById('report-template')).set(opt).save().then(() => {
            reportBtn.disabled = false;
            reportBtn.innerHTML = '<i class="fa-solid fa-file-pdf"></i> Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ø§Ù…Ù„ (PDF)';
            toast("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­");
        });
    }

    function calcStats() {
        const total = requestsCache.length;
        const done = requestsCache.filter(r => r.status === 'done').length;
        const working = requestsCache.filter(r => ['at_engineer','at_tech','working'].includes(r.status)).length;
        const rejected = requestsCache.filter(r => r.status === 'rejected').length;
        
        // ØªØ­Ø¯ÙŠØ« Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø´Ø§Ø´Ø©
        if(userData.role === 'manager' || userData.role === 'engineer') {
            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-done').innerText = done;
            document.getElementById('stat-working').innerText = working;
            document.getElementById('stat-rejected').innerText = rejected;
        }
        return { total, done, working, rejected };
    }

    async function getTechPerformance() {
        const techSnap = await db.collection('users').where('role','==','technician').get();
        let performance = [];
        
        techSnap.forEach(doc => {
            const tech = doc.data();
            const doneTasks = requestsCache.filter(r => r.technicianId === doc.id && r.status === 'done').length;
            const activeTasks = requestsCache.filter(r => r.technicianId === doc.id && r.status === 'at_tech').length;
            performance.push({ name: tech.fullName, doneTasks, activeTasks });
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±
        const perfList = document.getElementById('technicians-performance-list');
        if(perfList) {
            perfList.innerHTML = performance.map(t => `
                <div class="tech-report-item">
                    <div>
                        <b style="font-size:14px; display:block;">${t.name}</b>
                        <small style="color:var(--text-muted);">ÙÙ†ÙŠ ØµÙŠØ§Ù†Ø© Ù…Ø¹ØªÙ…Ø¯</small>
                    </div>
                    <div style="text-align:left;">
                        <span style="color:var(--success); font-weight:900;">${t.doneTasks} Ù…ÙƒØªÙ…Ù„</span><br>
                        <span style="color:var(--warning); font-size:11px;">${t.activeTasks} Ø¬Ø§Ø±ÙŠ</span>
                    </div>
                </div>
            `).join('') || '<p style="text-align:center; font-size:12px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ†ÙŠÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
        }
        return performance;
    }

    /* =========================================================================
       5. ÙˆØ¸Ø§Ø¦Ù Ø¥Ø±Ø³Ø§Ù„ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª (Core Actions)
       =========================================================================
    */

    async function openSupModal() {
        const desc = document.getElementById('req-desc').value;
        const type = document.getElementById('req-type').value;
        const faculty = document.getElementById('req-faculty').value;

        if(!desc || !type || !faculty) return toast("âš ï¸ Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ù„Ø§Øº Ø£ÙˆÙ„Ø§Ù‹");

        document.getElementById('sup-modal').classList.remove('hidden');
        const listDiv = document.getElementById('sup-list');
        listDiv.innerHTML = '<p style="text-align:center; padding:20px;"><i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†...</p>';

        const supSnap = await db.collection('users').where('role','==','supervisor').get();
        listDiv.innerHTML = "";
        
        if(supSnap.empty) {
            listDiv.innerHTML = '<p style="text-align:center; color:red;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø±ÙÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
            return;
        }

        supSnap.forEach(doc => {
            const u = doc.data();
            listDiv.innerHTML += `
                <div class="friend-item" onclick="selectSup(this, '${doc.id}')" style="margin-bottom:10px; border:2px solid transparent;">
                    <img src="${u.photoUrl}" style="width:45px; height:45px; border-radius:50%;">
                    <div style="flex:1;">
                        <b style="font-size:14px; display:block;">${u.fullName}</b>
                        <small style="color:var(--primary); font-weight:700;">${u.jobTitle || 'Ù…Ø´Ø±Ù ØµÙŠØ§Ù†Ø©'}</small>
                    </div>
                </div>
            `;
        });
    }

    function selectSup(el, id) {
        document.querySelectorAll('#sup-list .friend-item').forEach(item => {
            item.style.borderColor = 'transparent';
            item.style.background = 'white';
        });
        el.style.borderColor = 'var(--primary)';
        el.style.background = 'var(--primary-light)';
        selectedSup = id;
    }

    async function sendRequestFinal() {
        if(!selectedSup) return toast("âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±Ù");
        
        const btn = document.getElementById('confirm-send-btn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-paper-plane fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ù„Ø£Ø±Ø´ÙØ©...';

        try {
            // 1. Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¥Ù„Ù‰ Cloudinary
            let mediaLinks = [];
            for (const file of uploadQueue) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUD_PRESET);
                
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                mediaLinks.push({ 
                    url: data.secure_url, 
                    type: file.type.startsWith('image') ? 'image' : (file.type.startsWith('audio') ? 'audio' : 'video') 
                });
            }

            const uniqueCode = Math.random().toString(36).substr(2, 4).toUpperCase();
            
            // 2. Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø¨Ù„Ø§Øº
            await db.collection('requests').add({
                userId: currentUser.uid,
                requesterName: userData.fullName, // ØªÙ… Ø§Ù„Ø±Ø¨Ø· ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª
                requesterPic: userData.photoUrl,
                supervisorId: selectedSup,
                status: 'pending',
                type: document.getElementById('req-type').value,
                priority: document.querySelector('input[name="prio"]:checked').value,
                description: document.getElementById('req-desc').value,
                location: document.getElementById('req-faculty').value + " - " + document.getElementById('req-room').value,
                date: document.getElementById('req-date').value,
                time: document.getElementById('req-time').value,
                media: mediaLinks,
                uniqueCode: uniqueCode,
                isDeleted: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            toast(`âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ø¨Ù†Ø¬Ø§Ø­! ÙƒÙˆØ¯ Ø§Ù„ØªØªØ¨Ø¹: ${uniqueCode}`);
            closeModal('sup-modal');
            uploadQueue = [];
            document.getElementById('preview-grid').innerHTML = "";
            document.getElementById('req-desc').value = "";
            nav('home', document.querySelector('.nav-item:first-child'));
        } catch (e) {
            console.error(e);
            toast("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
        } finally {
            btn.disabled = false;
            btn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù†";
        }
    }

    function loadFeed() {
        let query = db.collection('requests');

        // ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØªØ¨Ø©
        if (userData.role === 'employee') {
            query = query.where('userId', '==', currentUser.uid);
        } else if (userData.role === 'supervisor') {
            query = query.where('supervisorId', '==', currentUser.uid);
        } else if (userData.role === 'engineer') {
            query = query.where('engineerId', '==', currentUser.uid);
        } else if (userData.role === 'technician') {
            query = query.where('technicianId', '==', currentUser.uid);
        }

        query.onSnapshot(snapshot => {
            requestsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            requestsCache.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            
            if(!isFirstLoad) {
                // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„ØµÙˆØªÙŠ Ù„Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                const newReq = requestsCache[0];
                if(newReq && newReq.createdAt?.seconds > (Date.now()/1000 - 10)) {
                    document.getElementById('notify-sound').play().catch(e => {});
                    toast("ğŸ”” Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©");
                }
            }
            isFirstLoad = false;
            calcStats();
            renderFeed();
        });
    }

    function renderFeed() {
        const container = document.getElementById('requests-feed');
        container.innerHTML = "";

        let list = requestsCache;

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± (ØªØ¨ÙˆÙŠØ¨Ø§Øª)
        if (currentTab === 'trash') {
            list = list.filter(r => r.isDeleted === true);
        } else {
            list = list.filter(r => r.isDeleted !== true);
            if (currentTab === 'active') {
                list = list.filter(r => !['done', 'rejected'].includes(r.status));
            } else {
                list = list.filter(r => ['done', 'rejected'].includes(r.status));
            }
        }

        if (list.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; padding:60px 20px; color:var(--text-muted);">
                    <i class="fa-solid fa-folder-open fa-3x" style="opacity:0.2; margin-bottom:15px;"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                </div>
            `;
            return;
        }

        list.forEach(req => {
            const prioColor = req.priority === 'high' ? 'var(--error)' : (req.priority === 'medium' ? 'var(--warning)' : 'var(--success)');
            
            container.innerHTML += `
                <div class="glass-card request-card" onclick="openRequestDetails('${req.id}')" style="border-right-color: ${prioColor};">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <img src="${req.requesterPic}" style="width:45px; height:45px; border-radius:50%; border:2px solid white; box-shadow:var(--shadow-sm);">
                            <div>
                                <b style="font-size:14px; display:block;">${req.requesterName} <span class="req-code-badge">#${req.uniqueCode}</span></b>
                                <span style="font-size:10px; color:var(--text-muted); font-weight:700;"><i class="fa-regular fa-clock"></i> ${req.date} | ${req.time}</span>
                            </div>
                        </div>
                        <span class="status-pill st-${req.status}">${getStatusText(req.status)}</span>
                    </div>
                    
                    <div style="font-size:14px; font-weight:700; color:var(--dark); margin-bottom:8px;">
                        <span style="color:var(--primary);">[${req.type}]</span> ${req.description}
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; font-size:11px; color:var(--text-muted);">
                        <span><i class="fa-solid fa-location-dot"></i> ${req.location}</span>
                        ${req.technicianName ? `<span style="background:var(--primary-light); color:var(--primary); padding:2px 8px; border-radius:4px; font-weight:800;">Ø§Ù„ÙÙ†ÙŠ: ${req.technicianName}</span>` : ''}
                    </div>
                </div>
            `;
        });
    }

    function getStatusText(status) {
        const statuses = {
            'pending': 'Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø´Ø±Ù',
            'at_engineer': 'Ø¹Ù†Ø¯ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³',
            'at_tech': 'Ø¹Ù†Ø¯ Ø§Ù„ÙÙ†ÙŠ',
            'working': 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°',
            'pending_confirmation': 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÙƒÙŠØ¯Ùƒ',
            'done': 'Ù…ÙƒØªÙ…Ù„ âœ…',
            'rejected': 'Ù…Ø±ÙÙˆØ¶ âŒ'
        };
        return statuses[status] || status;
    }

    /* =========================================================================
       6. ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØªØ­Ø³ÙŠÙ†Ø§Øª (Helper Functions)
       =========================================================================
    */

    function setupPermissions() {
        const role = userData.role;
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±
        if (role === 'manager') {
            document.getElementById('nav-admin-btn').classList.remove('hidden');
            document.getElementById('mgr-trash-tab').classList.remove('hidden');
        }

        // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙÙ†ÙŠ ÙˆØ§Ù„Ù…Ù‡Ù†Ø¯Ø³ (Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ÙÙ‚Ø·)
        if (role === 'technician' || role === 'engineer') {
            document.querySelector('.nav-add-btn').style.display = 'none';
        }
    }

    function showScreen(id) {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app-container').classList.add('hidden');
        document.getElementById(id).classList.remove('hidden');
    }

    function toggleAuth() {
        isLoginMode = !isLoginMode;
        document.getElementById('reg-fields').classList.toggle('hidden');
        document.getElementById('confirm-pass-field').classList.toggle('hidden');
        document.getElementById('auth-btn').innerText = isLoginMode ? "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„" : "Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨";
        document.getElementById('auth-switch-text').innerHTML = isLoginMode ? 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <b style="color:var(--primary)">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</b>' : 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ <b style="color:var(--primary)">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</b>';
    }

    function nav(page, el) {
        document.querySelectorAll('.page-section').forEach(p => p.classList.add('hidden'));
        document.getElementById('page-' + page).classList.remove('hidden');
        
        if (el) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        }

        if (page === 'admin') getTechPerformance();
        if (page === 'profile') loadProfilePageData();
    }

    function loadProfilePageData() {
        document.getElementById('edit-id-display').innerText = userData.shortId;
        document.getElementById('edit-name').value = userData.fullName;
        document.getElementById('edit-job').value = userData.jobTitle || '';
        document.getElementById('edit-loc').value = userData.location || '';
        document.getElementById('edit-gender').value = userData.gender;
        document.getElementById('edit-current-pic').src = userData.photoUrl;
    }

    async function saveProfile() {
        const btn = document.getElementById('save-profile-btn');
        btn.disabled = true;
        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

        try {
            let picUrl = userData.photoUrl;
            if (document.getElementById('edit-profile-file').files[0]) {
                const formData = new FormData();
                formData.append('file', document.getElementById('edit-profile-file').files[0]);
                formData.append('upload_preset', CLOUD_PRESET);
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, { method: 'POST', body: formData });
                const d = await res.json();
                picUrl = d.secure_url;
            }

            const frame = document.querySelector('.frame-option.selected').classList.contains('f-gold') ? 'f-gold' : 
                          (document.querySelector('.frame-option.selected').classList.contains('f-blue') ? 'f-blue' : 
                          (document.querySelector('.frame-option.selected').classList.contains('f-grad') ? 'f-grad' : ''));

            await db.collection('users').doc(currentUser.uid).update({
                fullName: document.getElementById('edit-name').value,
                jobTitle: document.getElementById('edit-job').value,
                location: document.getElementById('edit-loc').value,
                gender: document.getElementById('edit-gender').value,
                photoUrl: picUrl,
                frame: frame
            });

            toast("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­");
            location.reload();
        } catch (e) {
            toast("âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«");
        }
    }

    function previewProfilePic(input) {
        if (input.files && input.files[0]) {
            document.getElementById('edit-current-pic').src = URL.createObjectURL(input.files[0]);
        }
    }

    function selectFrame(el, frameClass) {
        document.querySelectorAll('.frame-option').forEach(f => f.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('edit-frame-overlay').className = 'frame-overlay ' + frameClass;
    }

    function copyId() {
        navigator.clipboard.writeText(userData.shortId);
        toast("ğŸ“‹ ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù€ ID Ø¨Ù†Ø¬Ø§Ø­");
    }

    function toast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3500);
    }

    function closeModal(id) {
        document.getElementById(id).classList.add('hidden');
    }

    function logout() {
        auth.signOut().then(() => location.reload());
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    window.onload = () => {
        // Ø£ÙŠ Ù…Ù†Ø·Ù‚ ØªÙ‡ÙŠØ¦Ø© Ø¥Ø¶Ø§ÙÙŠ
    };

</script>
</body>
</html>
